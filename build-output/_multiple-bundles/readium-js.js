define("text",["module"],function(e){"use strict";var t,n,r,i,o,a=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],s=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,c=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,u="undefined"!=typeof location&&location.href,l=u&&location.protocol&&location.protocol.replace(/\:/,""),f=u&&location.hostname,d=u&&(location.port||void 0),p={},h=e.config&&e.config()||{};return t={version:"2.0.12",strip:function(e){if(e){e=e.replace(s,"");var t=e.match(c);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:h.createXhr||function(){var e,t,n;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;3>t;t+=1){n=a[t];try{e=new ActiveXObject(n)}catch(r){}if(e){a=[n];break}}return e},parseName:function(e){var t,n,r,i=!1,o=e.indexOf("."),a=0===e.indexOf("./")||0===e.indexOf("../");return-1!==o&&(!a||o>1)?(t=e.substring(0,o),n=e.substring(o+1,e.length)):t=e,r=n||t,o=r.indexOf("!"),-1!==o&&(i="strip"===r.substring(o+1),r=r.substring(0,o),n?n=r:t=r),{moduleName:t,ext:n,strip:i}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,n,r,i){var o,a,s,c=t.xdRegExp.exec(e);return c?(o=c[2],a=c[3],a=a.split(":"),s=a[1],a=a[0],!(o&&o!==n||a&&a.toLowerCase()!==r.toLowerCase()||(s||a)&&s!==i)):!0},finishLoad:function(e,n,r,i){r=n?t.strip(r):r,h.isBuild&&(p[e]=r),i(r)},load:function(e,n,r,i){if(i&&i.isBuild&&!i.inlineText)return void r();h.isBuild=i&&i.isBuild;var o=t.parseName(e),a=o.moduleName+(o.ext?"."+o.ext:""),s=n.toUrl(a),c=h.useXhr||t.useXhr;return 0===s.indexOf("empty:")?void r():void(!u||c(s,l,f,d)?t.get(s,function(n){t.finishLoad(e,o.strip,n,r)},function(e){r.error&&r.error(e)}):n([a],function(e){t.finishLoad(o.moduleName+"."+o.ext,o.strip,e,r)}))},write:function(e,n,r){if(p.hasOwnProperty(n)){var i=t.jsEscape(p[n]);r.asModule(e+"!"+n,"define(function () { return '"+i+"';});\n")}},writeFile:function(e,n,r,i,o){var a=t.parseName(n),s=a.ext?"."+a.ext:"",c=a.moduleName+s,u=r.toUrl(a.moduleName+s)+".js";t.load(c,r,function(){var n=function(e){return i(u,e)};n.asModule=function(e,t){return i.asModule(e,u,t)},t.write(e,c,n,o)},o)}},"node"===h.env||!h.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]?(n=require.nodeRequire("fs"),t.get=function(e,t,r){try{var i=n.readFileSync(e,"utf8");0===i.indexOf("ï»¿")&&(i=i.substring(1)),t(i)}catch(o){r&&r(o)}}):"xhr"===h.env||!h.env&&t.createXhr()?t.get=function(e,n,r,i){var o,a=t.createXhr();if(a.open("GET",e,!0),i)for(o in i)i.hasOwnProperty(o)&&a.setRequestHeader(o.toLowerCase(),i[o]);h.onXhr&&h.onXhr(a,e),a.onreadystatechange=function(){var t,i;4===a.readyState&&(t=a.status||0,t>399&&600>t?(i=new Error(e+" HTTP status: "+t),i.xhr=a,r&&r(i)):n(a.responseText),h.onXhrComplete&&h.onXhrComplete(a,e))},a.send(null)}:"rhino"===h.env||!h.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?t.get=function(e,t){var n,r,i="utf-8",o=new java.io.File(e),a=java.lang.System.getProperty("line.separator"),s=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(o),i)),c="";try{for(n=new java.lang.StringBuffer,r=s.readLine(),r&&r.length()&&65279===r.charAt(0)&&(r=r.substring(1)),null!==r&&n.append(r);null!==(r=s.readLine());)n.append(a),n.append(r);c=String(n.toString())}finally{s.close()}t(c)}:("xpconnect"===h.env||!h.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(r=Components.classes,i=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),o="@mozilla.org/windows-registry-key;1"in r,t.get=function(e,t){var n,a,s,c={};o&&(e=e.replace(/\//g,"\\")),s=new FileUtils.File(e);try{n=r["@mozilla.org/network/file-input-stream;1"].createInstance(i.nsIFileInputStream),n.init(s,1,0,!1),a=r["@mozilla.org/intl/converter-input-stream;1"].createInstance(i.nsIConverterInputStream),a.init(n,"utf-8",n.available(),i.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),a.readString(n.available(),c),a.close(),n.close(),t(c.value)}catch(u){throw new Error((s&&s.path||"")+": "+u)}}),t}),define("text!version.json",[],function(){return'{"readiumJs":{"sha":"05f6815a280c3cad175ba3738169918cd09f93e3","clean":false,"version":"0.20.0-alpha","chromeVersion":"2.20.0-alpha","tag":"0.17-124-g05f6815","branch":"feature/pluginsX","release":false,"timestamp":1433257894462},"readiumSharedJs":{"sha":"8c6e242204a36af9209f0e4d9b8b03cc27fa8455","clean":true,"version":"0.20.0-alpha","tag":"0.16-151-g8c6e242","branch":"feature/pluginsX","release":false,"timestamp":1433257894749},"readiumCfiJs":{"sha":"7b3e4358bef3ac856bd224d13084fad236b17fbb","clean":true,"version":"0.20.0-alpha","tag":"0.1.4-120-g7b3e435","branch":"feature/plugins","release":false,"timestamp":1433257894968}}'}),define("readium_js/epub-fetch/markup_parser",[],function(){var e=function(){var e=this;this.parseXml=function(t){return e.parseMarkup(t,"text/xml")},this.parseMarkup=function(e,t){var n=new window.DOMParser;return n.parseFromString(e,t)}};return e}),define("readium_js/epub-fetch/discover_content_type",["jquery","URIjs"],function(e,t){var n=void 0,r=function(){var n=this;r.suffixContentTypeMap={css:"text/css",epub:"application/epub+zip",gif:"image/gif",html:"text/html",jpg:"image/jpeg",jpeg:"image/jpeg",ncx:"application/x-dtbncx+xml",opf:"application/oebps-package+xml",png:"image/png",svg:"image/svg+xml",xhtml:"application/xhtml+xml"},this.identifyContentTypeFromFileName=function(e){var n=t(e).suffix(),i="application/octet-stream";return"undefined"!=typeof r.suffixContentTypeMap[n]&&(i=r.suffixContentTypeMap[n]),i},this.identifyContentType=function(t){var r=e.ajax({type:"HEAD",url:t,async:!1}).getResponseHeader("Content-Type");return null===r&&(r=n.identifyContentTypeFromFileName(t),console.log("guessed contentType ["+r+"] from URI ["+t+"]. Configuring the web server to provide the content type is recommended.")),r}};return n||(n=new r),n}),define("readium_js/epub-fetch/plain_resource_fetcher",["jquery","URIjs","./discover_content_type"],function(e,t,n){var r=function(t,r){function i(e,t,n){var r=s.resolveURI(e);if("undefined"==typeof e)throw"Fetched file relative path is undefined!";var i=new XMLHttpRequest;i.open("GET",r,!0),i.responseType="arraybuffer",i.onerror=n,i.onload=function(){t(i.response)},i.send()}var o,a,s=this;this.initialize=function(e){t.getXmlFileDom("META-INF/container.xml",function(n){a=t.getRootFile(n),o=s.resolveURI(a),e()},function(t){console.error("unable to find package document: "+t),o=r,e()})},this.resolveURI=function(e){return r+"/"+e},this.getPackageUrl=function(){return o},this.fetchFileContentsText=function(t,n,r){var i=s.resolveURI(t);if("undefined"==typeof i)throw"Fetched file URL is undefined!";e.ajax({isLocal:0===i.indexOf("http")?!1:!0,url:i,dataType:"text",async:!0,success:function(e){n(e)},error:function(e,t,n){console.error("Error when AJAX fetching "+i),console.error(t),console.error(n),r(n)}})},this.fetchFileContentsBlob=function(e,r,o){var a=t.getDecryptionFunctionForRelativePath(e);if(a){var s=r;r=function(e){a(e,function(e){s(e)})}}i(e,function(t){var i=new Blob([t],{type:n.identifyContentTypeFromFileName(e)});r(i)},o)},this.getPackageDom=function(e,n){s.fetchFileContentsText(a,function(n){var r=t.markupParser.parseXml(n);e(r)},n)}};return r}),define("readium_js/epub-fetch/zip_resource_fetcher",["jquery","URIjs","./discover_content_type","zip-ext"],function(e,t,n,r){var i=function(e,t,i){function o(e,n){s?e(s,n):(r.useWebWorkers=!0,r.workerScriptsPath=i,s=new r.fs.FS,s.importHttpContent(t,!0,function(){e(s,n)},n))}function a(e,n,r){if("undefined"==typeof e)throw"Fetched file relative path is undefined!";o(function(r,i){var o=r.find(e);"undefined"==typeof o||null===o?i(new Error("Entry "+e+" not found in zip "+t)):o.directory?i(new Error("Entry "+e+" is a directory while a file has been expected")):n(o)},function(){console.log("ERROR"),console.log(arguments),r(arguments)})}var s,c=!1;this.getPackageUrl=function(){return t},this.fetchFileContentsText=function(e,t,n){a(e,function(e){e.getText(t,void 0,c)},n)},this.fetchFileContentsData64Uri=function(e,t,r){a(e,function(r){r.getData64URI(n.identifyContentTypeFromFileName(e),t,void 0,c)},r)},this.fetchFileContentsBlob=function(t,r,i){var o=e.getDecryptionFunctionForRelativePath(t);if(o){var s=r;r=function(e){o(e,function(e){s(e)})}}a(t,function(e){e.getBlob(n.identifyContentTypeFromFileName(t),r,void 0,c)},i)}};return i}),define("readium_js/epub-fetch/content_document_fetcher",["jquery","underscore","URIjs","./discover_content_type"],function(e,t,n,r){var i=function(i,o,a,s,c){function u(e,t){var n=e.getElementsByTagName("base")[0];if(!n){n=e.createElement("base");var r=e.getElementsByTagName("head")[0];r&&r.insertBefore(n,r.childNodes[0])}n.setAttribute("href",t)}function l(e){e&&(e.message&&console.error(e.message),e.stack&&console.error(e.stack)),console.error(e)}function f(t,i,o,a,s,c,u){function l(n){e(t).data("epubZipOrigHref",i),e(t).attr(o,n)}var f=new n(i);if(""!==f.scheme())return void console.log("HTTP / absolute scheme res: "+i);if(0==i.indexOf("/")){console.log("Absolute path res: "+i);var d=window.location?window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""):"";return void l(d+i)}var p=I.convertPathRelativeToPackageToRelativeToBase(F),h="/"+new n(i).absoluteTo(p).toString(),m=C.getResourceURL(h);if(m)l(m);else{var v=e.Deferred();s.push(v),I.relativeToPackageFetchFileContents(h,a,function(n){var i=function(n){if("text"===a){var i=r.identifyContentTypeFromFileName(h),o=e(t).attr("type");o&&(i=o),n=new Blob([n],{type:i})}var s=window.URL.createObjectURL(n);C.putResource(h,s,n),l(s),v.resolve()};u?u(n,h,i):i(n)},c)}}function d(r,i,o,a,s){var c=r[0],u=r.slice(2),f=t.find(u,function(e){return"undefined"!=typeof e}),d=new n(f),h=""===d.scheme();if(h){var m=I.convertPathRelativeToPackageToRelativeToBase(o);"/"===m.charAt(0)&&(m=m.substr(1));var v="/"+new n(f).absoluteTo(m).toString(),g=C.getResourceURL(v);if(g)a[c]={isStyleSheetResource:s,resourceObjectURL:g};else{var y=e.Deferred();i.push(y);var b,w,_=function(e){var t=window.URL.createObjectURL(e);a[c]={isStyleSheetResource:s,resourceObjectURL:t},C.putResource(v,t,e),y.resolve()},x=function(e){l(e),y.resolve()};s?(b="text",w=function(e){p(e,v,function(e){var t=new Blob([e],{type:"text/css"});_(t)})}):(b="blob",w=_),I.relativeToPackageFetchFileContents(v,b,w,x)}}}function p(t,n,r){var i=/[Uu][Rr][Ll]\(\s*([']([^']+)[']|["]([^"]+)["]|([^)]+))\s*\)/g,o=/@[Ii][Mm][Pp][Oo][Rr][Tt]\s*('([^']+)'|"([^"]+)")/g,a={},s=[];[o,i].forEach(function(e){for(var r=e.exec(t);null!=r;){var i=!1;e==o&&(i=!0),d(r,s,n,a,i),r=e.exec(t)}}),s.length>0?e.when.apply(e,s).done(function(){for(var e in a){var n,i=a[e];n=i.isStyleSheetResource?'@import "'+i.resourceObjectURL+'"':"url('"+i.resourceObjectURL+"')";var o=e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),s=new RegExp(o,"g");t=t.replace(s,n,"g")}r(t)}):r(t)}function h(t,n,r,i,o,a){var s=e(t+"["+n.replace(":","\\:")+"]",R);s.each(function(t,s){var c=e(s).attr(n);f(s,c,n,r,i,o,a)})}function m(e,t){h("img","src","blob",e,t),h("image","xlink:href","blob",e,t)}function v(e,t){h("audio","src","blob",e,t)}function g(e,t){h("video","src","blob",e,t),h("video","poster","blob",e,t)}function y(e,t){h("script","src","blob",e,t)}function b(e,t){h("iframe","src","blob",e,t,function(e,t,n){n(e)})}function w(e,t){h("link","href","text",e,t,p)}function _(t){var n=e("style",R);n.each(function(n,r){var i=e.Deferred();t.push(i);var o=e(r).text();p(o,F,function(t){e(r).text(t),i.resolve()})})}var x,R,T=this,F=o.href,I=i,k=o.media_type,C=s,P=c;this.fetchContentDocumentAndResolveDom=function(e,t){I.relativeToPackageFetchFileContents(F,"text",function(n){x=n,P&&(x=P(a,x)),T.resolveInternalPackageResources(e,t)},t)},this.resolveInternalPackageResources=function(t,n){R=I.markupParser.parseMarkup(x,k),u(R,a);var r=[];I.shouldFetchMediaAssetsProgrammatically()&&(m(r,n),v(r,n),g(r,n)),b(r,n),y(r,n),w(r,n),_(r,n),e.when.apply(e,r).done(function(){t(R)})}};return i}),define("readium_js/epub-fetch/resource_cache",["underscore"],function(e){var t=function(t,n){function r(){return(new Date).getTime()}function i(){return window.performance&&window.performance.memory&&window.performance.memory.jsHeapSizeLimit?window.performance.memory.jsHeapSizeLimit:null}function o(){if(n)return n;var e=i();return e&&e/10>f?e/10:f}function a(e){if("undefined"!=typeof e.orderingByLastUseTimestampIdx){var t=e.orderingByLastUseTimestampIdx;u.splice(t,1);for(var n=t;n<u.length;n++){var r=u[n];r.orderingByLastUseTimestampIdx-1!=n&&console.error("algorithm incorrect: downshiftedEntry.orderingByLastUseTimestampIdx: "+r.orderingByLastUseTimestampIdx+", i: "+n+" -- "+e.absoluteHref),r.orderingByLastUseTimestampIdx=n}}}function s(t){a(t);var n=e.sortedIndex(u,t,"lastUseTimestamp");u.splice(n,0,t),t.orderingByLastUseTimestampIdx=n}var c={},u=[],l=0,f=1e8,d=o();this.getResourceURL=function(e){var t=null,n=c[e];return n&&(t=n.url,n.lastUseTimestamp=r(),s(n)),t},this.putResource=function(e,t,n){this.trimCache();var i=r(),o={url:t,absoluteHref:e,blob:n,blobSize:n.size,creationTimestamp:i,lastUseTimestamp:i,pinned:!0};c[e]=o,s(o),l+=n.size},this.evictResource=function(e){var n=c[e];n&&(t.URL.revokeObjectURL(n.url),l-=n.blobSize,a(n),delete c[e])},this.flushCache=function(){for(var e in c)this.evictResource(e);0!=l&&(console.error("cacheSize accounting error! cacheSize: "+l+", _resourcesHash:"),console.error(c)),u=[]},this.unPinResources=function(){for(var e in c){var t=c[e];t.pinned=!1}},this.trimCache=function(){if(!(d>l)){console.log("Trimming cache. Current cache size: "+l);for(var e=0;e<u.length&&!(d>l);e++){var t=u[e];if(!t.pinned){var n=t.absoluteHref;this.evictResource(n),e--}}console.log("Cache size after trimming: "+l)}}};return t}),define("readium_js/epub-fetch/encryption_handler",["cryptoJs/sha1"],function(e){var t=function(e){function t(e,t){var n=new FileReader;n.onload=function(){var e=this.result;t(new Uint8Array(e))},n.readAsArrayBuffer(e)}function n(e,n,r,i){var o=e.slice(0,n);t(o,function(t){for(var o=r.length,a=0;n>a;a++)t[a]=t[a]^r[a%o];var s=new Blob([t],{type:e.type}),c=e.slice(n),u=new Blob([s,c],{type:e.type});i(u)})}function r(t,r){var i=1040;n(t,i,e.uidHash,r)}function i(e){var t=/(urn:uuid:)?([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/i,n=t.exec(e),r=n[2]+n[3]+n[4]+n[5]+n[6];r&&32==r.length||console.error("Bad UUID format for ID :"+e);for(var i=[],o=0;16>o;o++){var a=r.substr(2*o,2),s=parseInt(a,16);i.push(s)}return i}function o(t,r){var o=i(e.uid),a=1024;n(t,a,o,r)}var a=this,s={"http://www.idpf.org/2008/embedding":r,"http://ns.adobe.com/pdf/enc#RC":o};this.isEncryptionSpecified=function(){return e&&e.encryptions},this.getEncryptionMethodForRelativePath=function(t){return a.isEncryptionSpecified()?e.encryptions[t]:void 0},this.getDecryptionFunctionForRelativePath=function(e){var t=a.getEncryptionMethodForRelativePath(e);return t&&s[t]?s[t]:void 0}};return t.CreateEncryptionData=function(t,n){var r={uid:t,uidHash:e(unescape(encodeURIComponent(t.trim())),{asBytes:!0}),encryptions:void 0},i=$("EncryptedData",n);return i.each(function(e,t){var n=$("EncryptionMethod",t).first().attr("Algorithm"),i=$("CipherReference",t);i.each(function(e,t){var i=$(t).attr("URI");console.log("Encryption/obfuscation algorithm "+n+" specified for "+i),r.encryptions||(r.encryptions={}),r.encryptions[i]=n})}),r},t}),define("readium_js/epub-fetch/publication_fetcher",["jquery","URIjs","./markup_parser","./plain_resource_fetcher","./zip_resource_fetcher","./content_document_fetcher","./resource_cache","./encryption_handler","./discover_content_type"],function(e,t,n,r,i,o,a,s,c){var u=function(u,l,f,d,p){function h(e){e&&(e.message&&console.error(e.message),e.stack&&console.error(e.stack)),console.error(e)}function m(){var e=".epub";return-1===u.indexOf(e,u.length-e.length)}function v(e,t){return e?(console.log("using new PlainResourceFetcher"),b=new r(g,u),void b.initialize(function(){t(b)})):(console.log("using new ZipResourceFetcher"),b=new i(g,u,l),t(b),void 0)}var g=this;g.contentTypePackageReadStrategyMap={"application/oebps-package+xml":"exploded","application/epub+zip":"zipped","application/zip":"zipped"};var y,b,w,_,x,R,T=new a(f,d),F=p;this.markupParser=new n,this.initialize=function(e){var t=m();y=!t,v(t,e)},this.shouldConstructDomProgrammatically=function(){return y},this.shouldFetchMediaAssetsProgrammatically=function(){return y&&!m()},this.getBookRoot=function(){return u},this.getJsLibRoot=function(){return l},this.flushCache=function(){T.flushCache()},this.getPackageUrl=function(){return b.getPackageUrl()},this.fetchContentDocument=function(e,t,n,r){T.unPinResources();var i=new o(g,e.spineItem,t,T,F);i.fetchContentDocumentAndResolveDom(n,function(e){h(e),r(e)})},this.getFileContentsFromPackage=function(e,t,n){b.fetchFileContentsText(e,function(e){t(e)},n)},this.getXmlFileDom=function(e,t,n){g.getFileContentsFromPackage(e,function(e){var n=g.markupParser.parseXml(e);t(n)},n)},this.getPackageFullPath=function(e,t){g.getXmlFileDom("META-INF/container.xml",function(t){var n=g.getRootFile(t);e(n)},t)},this.getRootFile=function(t){var n=e("rootfile",t),r=n.attr("full-path");return r},this.getPackageDom=function(t,n){x?t(x):R?R.done(t):(R=e.Deferred(),R.done(t),g.getPackageFullPath(function(e){_=e,g.getXmlFileDom(e,function(e){x=e,R.resolve(e),R=void 0})},n))},this.convertPathRelativeToPackageToRelativeToBase=function(e){return new t(e).absoluteTo(_).toString()},this.relativeToPackageFetchFileContents=function(n,r,i,o){if(o||(o=h),y&&""!==new t(n).scheme())if("blob"===r){var a=new XMLHttpRequest;a.open("GET",n,!0),a.responseType="arraybuffer",a.onerror=o,a.onload=function(){var e=new Blob([a.response],{type:c.identifyContentTypeFromFileName(n)});i(e)},a.send()}else"data64uri"===r?console.error("data64uri??"):e.ajax({isLocal:!1,url:n,dataType:"text",async:!0,success:function(e){i(e)},error:function(e,t,r){console.error("Error when AJAX fetching "+n),console.error(t),console.error(r),o(r)}});else{var s=decodeURIComponent(g.convertPathRelativeToPackageToRelativeToBase(n));"/"===s.charAt(0)&&(s=s.substr(1));var u=b.fetchFileContentsText;"blob"===r?u=b.fetchFileContentsBlob:"data64uri"===r&&(console.error("data64uri??"),u=b.fetchFileContentsData64Uri),u.call(b,s,i,o)}},this.getRelativeXmlFileDom=function(e,t,n){g.getXmlFileDom(g.convertPathRelativeToPackageToRelativeToBase(e),t,n)},this.setPackageMetadata=function(e,t){g.getXmlFileDom("META-INF/encryption.xml",function(n){var r=s.CreateEncryptionData(e.id,n);w=new s(r),w.isEncryptionSpecified()&&(y=!0),t()},function(){console.log("Document doesn't make use of encryption."),w=new s(void 0),t()})},this.getDecryptionFunctionForRelativePath=function(e){return w.getDecryptionFunctionForRelativePath(e)}};return u}),define("readium_js/epub-model/package_document",["jquery","underscore","URIjs"],function(e,t,n){var r=function(t,r,i,o,a){function s(){var e=l(),t=e.href,n=t.substr(t.lastIndexOf(".")+1);return"ncx"===n.trim().toLowerCase()}function c(t){var n=e("<ol></ol>");return e.each(t.children("navPoint"),function(t,r){u(e(r),n)}),n}function u(t,n){var r=t.children("navLabel").text().trim(),i=t.children("content").attr("src"),o=e('<li class="nav-elem"></li>').append(e("<a></a>",{href:i,text:r}));if(n.append(o),t.children("navPoint").length>0){var a=e("<li></li>"),s=e("<ol></ol>");e.each(t.children("navPoint"),function(t,n){s.append(u(e(n),s))}),a.append(s),n.append(a)}}function l(){var e=a.getNavItem();if(e)return e;var t=i.ncx;return t&&t.length>0?a.getManifestItemByIdref(t):null}var f;this.manifest=a,this.getSharedJsPackageData=function(){var e=t.substr(0,t.lastIndexOf("/"));return{rootUrl:e,rendition_viewport:i.rendition_viewport,rendition_layout:i.rendition_layout,rendition_orientation:i.rendition_orientation,rendition_flow:i.rendition_flow,rendition_spread:i.rendition_spread,media_overlay:i.media_overlay,spine:{direction:this.getPageProgressionDirection(),items:o}}},this.getSpineItem=function(e){var t=o[e];return t},this.setPageProgressionDirection=function(e){f=e},this.getPageProgressionDirection=function(){return"rtl"===f?"rtl":"default"===f?"default":"ltr"},this.spineLength=function(){return o.length},this.getMetadata=function(){return i},this.getToc=function(){var e=l();return e?e.href:null},this.getTocText=function(e){var t=this.getToc();r.relativeToPackageFetchFileContents(t,"text",function(t){e(t)},function(n){console.error("ERROR fetching TOC from ["+t+"]:"),console.error(n),e(void 0)})},this.getTocDom=function(e){this.getTocText(function(t){if("string"==typeof t){var n=(new DOMParser).parseFromString(t,"text/xml");e(n)}else e(void 0)})},this.generateTocListDOM=function(r){var i=this;this.getTocDom(function(o){if(o)if(s()){var a;a=c(e("navMap",o)),r(a[0])}else{var u=new n(t).absoluteTo(document.URL),l=new n(i.getToc()).absoluteTo(u),f=(e(o).remove("base"),e("<base></base>"));e(f).attr("href",l),e(o).find("head").append(f),r(o)}else r(void 0)})}};return r}),define("readium_js/epub-model/smil_document_parser",["jquery","underscore"],function(e){var t=function(n,r){function i(e){return{id:"",href:"",spineItemId:e.idref,children:[{nodeType:"seq",textref:e.href,children:[{nodeType:"par",children:[{nodeType:"text",src:e.href,srcFile:e.href,srcFragmentId:""}]}]}]}}this.parse=function(t,i,o,a,s,c){var u=this;r.getRelativeXmlFileDom(i.href,function(r){var c=e("smil",r)[0];o.smilVersion=c.getAttribute("version"),o.children=u.getChildren(c),o.href=i.href,o.id=i.id,o.spineItemId=t.idref;var l=n.getMetadata().getMediaItemByRefinesId(i.id);l&&(o.duration=l.duration),s(a,o)},function(e){c(a,e)})};var o=function(e,t,n,r,i){var o=e.split(":"),a=o[o.length-1];"type"===a&&(a="epubtype"),void 0!=t.getAttribute(e)?n[a]=t.getAttribute(e):r&&(void 0!==i?n[a]=i:console.log("Required property "+e+" not found in smil node "+t.nodeName))};this.getChildren=function(t){var n=this,r=[];return e.each(t.childNodes,function(e,t){if(1===t.nodeType){var i=n.createItemFromElement(t);i&&r.push(i)}}),r},this.createItemFromElement=function(e){var n=this,r={};r.nodeType=e.nodeName;var i=!1;if("body"===r.nodeType&&(i=!0,r.nodeType="seq"),"seq"===r.nodeType)o("epub:textref",e,r,!i),o("id",e,r),o("epub:type",e,r),r.children=n.getChildren(e);else if("par"===r.nodeType)o("id",e,r),o("epub:type",e,r),r.children=n.getChildren(e);else if("text"===r.nodeType){o("src",e,r,!0);var a=r.src.split("#");r.srcFile=a[0],r.srcFragmentId=2===a.length?a[1]:"",o("id",e,r)}else{if("audio"!==r.nodeType)return void 0;o("src",e,r,!0),o("id",e,r),r.clipBegin=t.resolveClockValue(e.getAttribute("clipBegin")),r.clipEnd=t.resolveClockValue(e.getAttribute("clipEnd"))}return r},this.fillSmilData=function(t){var r=this;if(n.spineLength()<=0)return void t();for(var o=!0,a=[],s=[],c=0;c<n.spineLength();c++){var u=n.getSpineItem(c);if(u.media_overlay_id){var l=n.manifest.getManifestItemByIdref(u.media_overlay_id);if(!l){console.error("Cannot find SMIL manifest item for spine/manifest item?! "+u.media_overlay_id);continue}var f=e.Deferred();f.media_overlay_id=u.media_overlay_id,s.push(f);var d={};a.push(d),r.parse(u,l,d,f,function(e){o=!1,e.resolve()},function(e,t){console.log("Error when parsing SMIL manifest item "+l.href+":"),console.log(t),e.resolve()})}else a.push(i(u))}e.when.apply(e,s).done(function(){n.getMetadata().setMoMap(a),o&&(console.log("No Media Overlays"),n.getMetadata().setMoMap([])),t()})}};return t.resolveClockValue=function(e){if(!e)return 0;var t=0,n=0,r=0;if(-1!=e.indexOf("min"))n=parseFloat(e.substr(0,e.indexOf("min")));else if(-1!=e.indexOf("ms")){var i=parseFloat(e.substr(0,e.indexOf("ms")));r=i/1e3}else if(-1!=e.indexOf("s"))r=parseFloat(e.substr(0,e.indexOf("s")));else if(-1!=e.indexOf("h"))t=parseFloat(e.substr(0,e.indexOf("h")));else{var o=e.split(":");r=parseFloat(o.pop()),o.length>0&&(n=parseFloat(o.pop()),o.length>0&&(t=parseFloat(o.pop())))}var a=3600*t+60*n+r;return a},t}),define("readium_js/epub-model/metadata",["underscore"],function(e){var t=function(){var t=this,n={};this.eachMediaItem=function(n){return t.mediaItems&&e.each(t.mediaItems,n),this},this.getMediaItemByRefinesId=function(e){return n[e]},this.setMoMap=function(e){t.media_overlay.smil_models=e},this.eachMediaItem(function(e){var t=e.refines,r=t.indexOf("#");if(r>=0){var i=r+1,o=t.length-1;t=t.substr(i,o)}t=t.trim(),n[t]=e})};return t}),define("readium_js/epub-model/manifest",["underscore"],function(e){var t=function(t){var n,r={};this.manifestLength=function(){return t.length},this.getManifestItemByIdref=function(e){return r[e]},this.each=function(n){return e.each(t,n),this},this.getNavItem=function(){return n},this.each(function(e){r[e.id]=e,e.properties&&-1!==e.properties.indexOf("nav")&&(n=e)})};return t}),define("readium_js/epub-model/package_document_parser",["jquery","underscore","../epub-fetch/markup_parser","URIjs","./package_document","./smil_document_parser","./metadata","./manifest"],function(e,t,n,r,i,o,a,s){var c=function(r,c){function u(e){e&&(e.message&&console.error(e.message),e.stack&&console.error(e.stack))}function l(e,t){var n=new o(e,c);n.fillSmilData(function(){t(e)})}function f(t){var r=e.Deferred();if(t.rendition_layout)r.resolve();else{var i="/META-INF/com.apple.ibooks.display-options.xml";c.relativeToPackageFetchFileContents(i,"text",function(i){if(i){var o=new n,a=o.parseXml(i),s=e("option[name=fixed-layout]",a)[0];if(s){var c=e(s).text();"true"===c&&(t.rendition_layout="pre-paginated",console.log("using com.apple.ibooks.display-options.xml fixed-layout property"))}}r.resolve()},function(){console.log("com.apple.ibooks.display-options.xml not found"),r.resolve()})}return r.promise()}function d(n,r,i){var o,a=[];return o=e(p(n,"spine")).children(),e.each(o,function(n,o){var s=e(o),c=s.attr("idref")?s.attr("idref"):"",u=r.getManifestItemByIdref(c),l=s.attr("id"),f=void 0;t.each(i.rendition_viewports,function(e){return e.refines==l?(f=e.viewport,!0):void 0});var d={rendition_viewport:f,idref:c,href:u.href,manifest_id:u.id,media_type:u.media_type,media_overlay_id:u.media_overlay_id,linear:s.attr("linear")?s.attr("linear"):"",properties:s.attr("properties")?s.attr("properties"):""},p=x(d.properties);t.extend(d,p),a.push(d)}),a}function p(e,n,r){var i=e.getElementsByTagNameNS("*",n);return r?t.find(i,r):i[0]}function h(e,n,r){var i=e.getElementsByTagNameNS("*",n);return t.filter(i,r)}function m(e,t,n){var r=p(e,t,n);return r?r.textContent:""}function v(e,t,n,r){var i=p(e,t,r);return i?i.getAttribute(n):""}function g(e,t){var n=p(e,"meta",function(e){return e.getAttribute("property")===t});return n?n.textContent:""}function y(e){var n=new a,r=p(e,"metadata"),i=p(e,"package"),s=p(e,"spine");n.author=m(r,"creator"),n.description=m(r,"description"),n.epub_version=i.getAttribute("version")?i.getAttribute("version"):"",n.id=m(r,"identifier"),n.language=m(r,"language"),n.modified_date=g(r,"dcterms:modified"),n.ncx=s.getAttribute("toc")?s.getAttribute("toc"):"",n.pubdate=m(r,"date"),n.publisher=m(r,"publisher"),n.rights=m(r,"rights"),n.title=m(r,"title"),n.rendition_orientation=g(r,"rendition:orientation"),n.rendition_layout=g(r,"rendition:layout"),n.rendition_spread=g(r,"rendition:spread"),n.rendition_flow=g(r,"rendition:flow"),n.rendition_viewport=m(r,"meta",function(e){return"rendition:viewport"===e.getAttribute("property")&&!e.hasAttribute("refines")});var c=[],u=h(r,"meta",function(e){return"rendition:viewport"===e.getAttribute("property")&&e.hasAttribute("refines")});t.each(u,function(e){var t=e.getAttribute("refines");if(t){var n=t.indexOf("#");if(n>=0){var r=n+1,i=t.length-1;t=t.substr(r,i)}t=t.trim()}var o={refines:t,viewport:e.textContent};c.push(o)}),n.rendition_viewports=c,n.mediaItems=[];var l=h(r,"meta",function(e){return"media:duration"===e.getAttribute("property")&&e.hasAttribute("refines")});return t.each(l,function(e){n.mediaItems.push({refines:e.getAttribute("refines"),duration:o.resolveClockValue(e.textContent)})}),n.media_overlay={duration:o.resolveClockValue(m(r,"meta",function(e){return"media:duration"===e.getAttribute("property")&&!e.hasAttribute("refines")})),narrator:g(r,"media:narrator"),activeClass:g(r,"media:active-class"),playbackActiveClass:g(r,"media:playback-active-class"),smil_models:[],skippables:["sidebar","practice","marginalia","annotation","help","note","footnote","rearnote","table","table-row","table-cell","list","list-item","pagebreak"],escapables:["sidebar","bibliography","toc","loi","appendix","landmarks","lot","index","colophon","epigraph","conclusion","afterword","warning","epilogue","foreword","introduction","prologue","preface","preamble","notice","errata","copyright-page","acknowledgments","other-credits","titlepage","imprimatur","contributors","halftitlepage","dedication","help","annotation","marginalia","practice","note","footnote","rearnote","footnotes","rearnotes","bridgehead","page-list","table","table-row","table-cell","list","list-item","glossary"]},n}function b(t){var n=e(p(t,"manifest")).children(),r=[];return e.each(n,function(t,n){var i=e(n),o=i.attr("href")?i.attr("href"):"",a={href:o,id:i.attr("id")?i.attr("id"):"",media_overlay_id:i.attr("media-overlay")?i.attr("media-overlay"):"",media_type:i.attr("media-type")?i.attr("media-type"):"",properties:i.attr("properties")?i.attr("properties"):""};r.push(a)}),r}function w(t){var n=e(p(t,"bindings")).children(),r=[];return e.each(n,function(t,n){var i=e(n),o={handler:i.attr("handler")?i.attr("handler"):"",media_type:i.attr("media-type")?i.attr("media-type"):""};r.push(o)}),r}function _(n){var r,i;if(r=p(n,"manifest"),i=e(p(r,"item",function(e){var n=e.getAttribute("properties");return n&&t.contains(n.split(" "),"cover-image")})),1===i.length&&i.attr("href"))return i.attr("href");var o=e(p(n,"meta",function(e){return"cover"===e.getAttribute("name")})),a=o.attr("content");return 1===o.length&&a&&(i=e(p(r,"item",function(e){return e.getAttribute("id")===a})),1===i.length&&i.attr("href"))?i.attr("href"):(i=e(p(r,"item",function(e){return"cover"===e.getAttribute("id")})),1===i.length&&i.attr("href")?i.attr("href"):null)}function x(e){for(var t={},n=e.split(" "),r=0;r<n.length;r++)"rendition:orientation-landscape"===n[r]&&(t.rendition_orientation="landscape"),"rendition:orientation-portrait"===n[r]&&(t.rendition_orientation="portrait"),"rendition:orientation-auto"===n[r]&&(t.rendition_orientation="auto"),"rendition:spread-none"===n[r]&&(t.rendition_spread="none"),"rendition:spread-landscape"===n[r]&&(t.rendition_spread="landscape"),"rendition:spread-portrait"===n[r]&&(t.rendition_spread="portrait"),"rendition:spread-both"===n[r]&&(t.rendition_spread="both"),"rendition:spread-auto"===n[r]&&(t.rendition_spread="auto"),"rendition:flow-paginated"===n[r]&&(t.rendition_flow="paginated"),"rendition:flow-scrolled-continuous"===n[r]&&(t.rendition_flow="scrolled-continuous"),"rendition:flow-scrolled-doc"===n[r]&&(t.rendition_flow="scrolled-doc"),"rendition:flow-auto"===n[r]&&(t.rendition_flow="auto"),"rendition:page-spread-center"===n[r]&&(t.page_spread="page-spread-center"),"page-spread-left"===n[r]&&(t.page_spread="page-spread-left"),"page-spread-right"===n[r]&&(t.page_spread="page-spread-right"),"rendition:layout-reflowable"===n[r]&&(t.fixed_flow=!1,t.rendition_layout="reflowable"),"rendition:layout-pre-paginated"===n[r]&&(t.fixed_flow=!0,t.rendition_layout="pre-paginated");return t}var R,T=c,F=e.Deferred();c.getPackageDom(function(e){R=e,F.resolve(e)},u),this.parse=function(t){F.done(function(n){var r=y(n),o=(n.getElementsByTagNameNS("*","spine")[0],v(n,"spine","page-progression-direction")),a=(w(n),new s(b(n))),u=d(n,a,r),p=_(n);p&&(r.cover_href=p),e.when(f(r)).then(function(){T.setPackageMetadata(r,function(){var e=new i(c.getPackageUrl(),c,r,u,a);
e.setPageProgressionDirection(o),l(e,t)})})})}};return c}),define("readium_js/epub-fetch/iframe_zip_loader",["URIjs","readium_shared_js/views/iframe_loader","underscore"],function(e,t,n){var r=function(r,i){function o(e,t){$.ajax({url:e,dataType:"html",async:!0,success:function(e){t(e)},error:function(n,r,i){console.error("Error when AJAX fetching "+e),console.error(r),console.error(i),t()}})}function a(e,t){o(e,function(n){return n?(u&&(n=u(e,n)),void t(n)):void t()})}var s=new t,c=this,u=i;this.addIFrameEventListener=function(e,t,n){s.addIFrameEventListener(e,t,n)},this.updateIframeEvents=function(e){s.updateIframeEvents(e)},this.loadIframe=function(t,n,i,o,s){t.baseURI||("undefined"!=typeof location&&(t.baseURI=location.href+""),console.log("!iframe.baseURI => "+t.baseURI)),t.setAttribute("data-baseUri",t.baseURI),t.setAttribute("data-src",n);var u=new e(n).absoluteTo(t.baseURI).search("").hash("").toString(),l=r().shouldConstructDomProgrammatically();l?r().fetchContentDocument(s,u,function(e){c._loadIframeWithDocument(t,s,e.documentElement.outerHTML,function(){i.call(o,!0,s)})},function(){i.call(o,!1,s)}):a(u,function(e){e?c._loadIframeWithDocument(t,s,e,function(){i.call(o,!0,s)}):i.call(o,!1,s)})},this._loadIframeWithDocument=function(e,t,r,i){var o=window.navigator.userAgent.indexOf("Trident")>0;if(o)e.contentWindow.document.open(),window.MSApp&&window.MSApp.execUnsafeLocalFunction?window.MSApp.execUnsafeLocalFunction(function(){e.contentWindow.document.write(r)}):e.contentWindow.document.write(r);else{var a="text/html";t.spineItem.media_type&&t.spineItem.media_type.length&&(a=t.spineItem.media_type);var s=window.URL.createObjectURL(new Blob([r],{type:a}))}e.onload=function(){c.updateIframeEvents(e);var t=e.contentWindow.MathJax;if(t){var r=n.once(i);t.Hub.Queue(r)}else i();o||window.URL.revokeObjectURL(s)},o?e.contentWindow.document.close():e.setAttribute("src",s)}};return r}),define("readium_js/Readium",["text!version.json","jquery","underscore","readium_shared_js/views/reader_view","readium_js/epub-fetch/publication_fetcher","readium_js/epub-model/package_document_parser","readium_js/epub-fetch/iframe_zip_loader","readium_shared_js/views/iframe_loader"],function(e,t,n,r,i,o,a,s){var c=function(e,n){var c,u={mathJaxUrl:n.mathJaxUrl},l=function(e,t){function n(){navigator.epubReadingSystem=window.parent.navigator.epubReadingSystem,window.parent=window.self,window.top=window.self}var r=e.split("/");r.pop();var i='<base href="'+r.join("/")+'/"/>',o='<script type="text/javascript">('+n.toString()+")()</script>";return u&&u.mathJaxUrl&&t.indexOf("<math")>=0&&(o+='<script type="text/javascript" src="'+u.mathJaxUrl+'"></script>'),t.replace(/(<head.*?>)/,"$1"+i+o)},f=this,d=e.jsLibRoot;n.iframeLoader=e.useSimpleLoader?new s:new a(function(){return c},l),n.needsFixedLayoutScalerWorkAround=!0,this.reader=new r(n),ReadiumSDK.reader=this.reader,this.openPackageDocument=function(n,r,a){c&&c.flushCache();var s=null;e.cacheSizeEvictThreshold&&(s=e.cacheSizeEvictThreshold),c=new i(n,d,window,s,l),c.initialize(function(){var i=new o(n,c);i.parse(function(n){var i=e.openBookOptions||{},o=t.extend(n.getSharedJsPackageData(),i);a&&(o.openPageRequest=a),f.reader.openBook(o);var s={packageDocumentUrl:c.getPackageUrl(),metadata:n.getMetadata()};r&&r(n,s)})})},this.closePackageDocument=function(){c&&c.flushCache()},ReadiumSDK.emit(ReadiumSDK.Events.READER_INITIALIZED,ReadiumSDK.reader)};return c.version=JSON.parse(e),c}),define("readium_js",["readium_js/Readium"],function(e){return e}),define("readium-js",function(){});
//# sourceMappingURL=readium-js.js.map