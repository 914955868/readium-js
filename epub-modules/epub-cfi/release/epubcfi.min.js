(function(o){var h={Config:{retrieveResource:function(b){var d;$.ajax({type:"GET",url:b,dataType:"xml",async:!1,success:function(e){d=e}});return d},packageDocumentURL:""}};h.Parser=function(){function b(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var d={parse:function(e,d){function g(a){c<p||(c>p&&(p=c,w=[]),w.push(a))}
function h(){var a,l,e,b;b=e=c;a=s();a!==null?(l=j(),l!==null?a=[a,l]:(a=null,c=b)):(a=null,c=b);a!==null&&(a={type:"cfiString",path:a[0],localPath:a[1]});a===null&&(c=e);return a}function j(){var a,l,e,b;b=e=c;l=s();l===null&&(l=x());if(l!==null)for(a=[];l!==null;)a.push(l),l=s(),l===null&&(l=x());else a=null;a!==null?(l=B(),l=l!==null?l:"",l!==null?a=[a,l]:(a=null,c=b)):(a=null,c=b);a!==null&&(a={steps:a[0],termStep:a[1]});a===null&&(c=e);return a}function s(){var a,l,b,d,f,h,t,i;t=h=c;e.charCodeAt(c)===
47?(a="/",c++):(a=null,k===0&&g('"/"'));a!==null?(l=u(),l!==null?(i=c,e.charCodeAt(c)===91?(b="[",c++):(b=null,k===0&&g('"["')),b!==null?(d=y(),d!==null?(e.charCodeAt(c)===93?(f="]",c++):(f=null,k===0&&g('"]"')),f!==null?b=[b,d,f]:(b=null,c=i)):(b=null,c=i)):(b=null,c=i),b=b!==null?b:"",b!==null?a=[a,l,b]:(a=null,c=t)):(a=null,c=t)):(a=null,c=t);a!==null&&(a={type:"indexStep",stepLength:a[1],idAssertion:a[2][1]});a===null&&(c=h);return a}function x(){var a,l,b,d,f,h,i,j;i=h=c;e.substr(c,2)==="!/"?
(a="!/",c+=2):(a=null,k===0&&g('"!/"'));a!==null?(l=u(),l!==null?(j=c,e.charCodeAt(c)===91?(b="[",c++):(b=null,k===0&&g('"["')),b!==null?(d=y(),d!==null?(e.charCodeAt(c)===93?(f="]",c++):(f=null,k===0&&g('"]"')),f!==null?b=[b,d,f]:(b=null,c=j)):(b=null,c=j)):(b=null,c=j),b=b!==null?b:"",b!==null?a=[a,l,b]:(a=null,c=i)):(a=null,c=i)):(a=null,c=i);a!==null&&(a={type:"indirectionStep",stepLength:a[1],idAssertion:a[2][1]});a===null&&(c=h);return a}function B(){var a,l,b,d,f,h,i,j;i=h=c;e.charCodeAt(c)===
58?(a=":",c++):(a=null,k===0&&g('":"'));a!==null?(l=u(),l!==null?(j=c,e.charCodeAt(c)===91?(b="[",c++):(b=null,k===0&&g('"["')),b!==null?(d=o(),d!==null?(e.charCodeAt(c)===93?(f="]",c++):(f=null,k===0&&g('"]"')),f!==null?b=[b,d,f]:(b=null,c=j)):(b=null,c=j)):(b=null,c=j),b=b!==null?b:"",b!==null?a=[a,l,b]:(a=null,c=i)):(a=null,c=i)):(a=null,c=i);a!==null&&(a={type:"textTerminus",offsetValue:a[1],textAssertion:a[2][1]});a===null&&(c=h);return a}function y(){var a,b;b=c;a=v();a===null&&(c=b);return a}
function o(){var a,b,e,d;d=e=c;a=C();a=a!==null?a:"";a!==null?(b=D(),b=b!==null?b:"",b!==null?a=[a,b]:(a=null,c=d)):(a=null,c=d);a!==null&&(a={type:"textLocationAssertion",csv:a[0],parameter:a[1]});a===null&&(c=e);return a}function D(){var a,b,d,f,h,i;i=h=c;e.charCodeAt(c)===59?(a=";",c++):(a=null,k===0&&g('";"'));a!==null?(b=z(),b!==null?(e.charCodeAt(c)===61?(d="=",c++):(d=null,k===0&&g('"="')),d!==null?(f=z(),f!==null?a=[a,b,d,f]:(a=null,c=i)):(a=null,c=i)):(a=null,c=i)):(a=null,c=i);a!==null&&
(a={type:"parameter",LHSValue:a[1],RHSValue:a[3]});a===null&&(c=h);return a}function C(){var a,b,d,f,h;h=f=c;a=v();a=a!==null?a:"";a!==null?(e.charCodeAt(c)===44?(b=",",c++):(b=null,k===0&&g('","')),b!==null?(d=v(),d=d!==null?d:"",d!==null?a=[a,b,d]:(a=null,c=h)):(a=null,c=h)):(a=null,c=h);a!==null&&(a={type:"csv",preAssertion:a[0],postAssertion:a[2]});a===null&&(c=f);return a}function z(){var a,b,e;e=c;b=q();b===null&&(b=r());if(b!==null)for(a=[];b!==null;)a.push(b),b=q(),b===null&&(b=r());else a=
null;a!==null&&(a=a.join(""));a===null&&(c=e);return a}function v(){var a,b,e;e=c;b=q();b===null&&(b=r(),b===null&&(b=A()));if(b!==null)for(a=[];b!==null;)a.push(b),b=q(),b===null&&(b=r(),b===null&&(b=A()));else a=null;a!==null&&(a=a.join(""));a===null&&(c=e);return a}function q(){var a,b,e,d;d=e=c;a=n();a!==null?(b=n(),b!==null?a=[a,b]:(a=null,c=d)):(a=null,c=d);a===null&&(d=c,a=n(),a!==null?(b=E(),b!==null?a=[a,b]:(a=null,c=d)):(a=null,c=d),a===null&&(d=c,a=n(),a!==null?(b=F(),b!==null?a=[a,b]:
(a=null,c=d)):(a=null,c=d),a===null&&(d=c,a=n(),a!==null?(b=G(),b!==null?a=[a,b]:(a=null,c=d)):(a=null,c=d),a===null&&(d=c,a=n(),a!==null?(b=H(),b!==null?a=[a,b]:(a=null,c=d)):(a=null,c=d),a===null&&(d=c,a=n(),a!==null?(b=I(),b!==null?a=[a,b]:(a=null,c=d)):(a=null,c=d))))));a!==null&&(a=a[1]);a===null&&(c=e);return a}function u(){var a,b,d,f,h;f=c;e.charCodeAt(c)===48?(a="0",c++):(a=null,k===0&&g('"0"'));if(a===null)if(h=c,/^[1-9]/.test(e.charAt(c))?(a=e.charAt(c),c++):(a=null,k===0&&g("[1-9]")),
a!==null){b=[];/^[0-9]/.test(e.charAt(c))?(d=e.charAt(c),c++):(d=null,k===0&&g("[0-9]"));for(;d!==null;)b.push(d),/^[0-9]/.test(e.charAt(c))?(d=e.charAt(c),c++):(d=null,k===0&&g("[0-9]"));b!==null?a=[a,b]:(a=null,c=h)}else a=null,c=h;a!==null&&(a=a==="0"?"0":a[0].concat(a[1].join("")));a===null&&(c=f);return a}function A(){var a,b;b=c;e.charCodeAt(c)===32?(a=" ",c++):(a=null,k===0&&g('" "'));a!==null&&(a=" ");a===null&&(c=b);return a}function n(){var a,b;b=c;e.charCodeAt(c)===94?(a="^",c++):(a=null,
k===0&&g('"^"'));a!==null&&(a="^");a===null&&(c=b);return a}function E(){var a,b;b=c;e.charCodeAt(c)===91?(a="[",c++):(a=null,k===0&&g('"["'));a===null&&(e.charCodeAt(c)===93?(a="]",c++):(a=null,k===0&&g('"]"')));a===null&&(c=b);return a}function F(){var a,b;b=c;e.charCodeAt(c)===40?(a="(",c++):(a=null,k===0&&g('"("'));a===null&&(e.charCodeAt(c)===41?(a=")",c++):(a=null,k===0&&g('")"')));a===null&&(c=b);return a}function G(){var a,b;b=c;e.charCodeAt(c)===44?(a=",",c++):(a=null,k===0&&g('","'));a!==
null&&(a=",");a===null&&(c=b);return a}function H(){var a,b;b=c;e.charCodeAt(c)===59?(a=";",c++):(a=null,k===0&&g('";"'));a!==null&&(a=";");a===null&&(c=b);return a}function I(){var a,b;b=c;e.charCodeAt(c)===61?(a="=",c++):(a=null,k===0&&g('"="'));a!==null&&(a="=");a===null&&(c=b);return a}function r(){var a,b;b=c;/^[a-z]/.test(e.charAt(c))?(a=e.charAt(c),c++):(a=null,k===0&&g("[a-z]"));a===null&&(/^[A-Z]/.test(e.charAt(c))?(a=e.charAt(c),c++):(a=null,k===0&&g("[A-Z]")),a===null&&(/^[0-9]/.test(e.charAt(c))?
(a=e.charAt(c),c++):(a=null,k===0&&g("[0-9]"))));a===null&&(c=b);return a}function K(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);return c}function L(){for(var a=1,b=1,d=!1,f=0;f<Math.max(c,p);f++){var g=e.charAt(f);g==="\n"?(d||a++,b=1,d=!1):g==="\r"||g==="\u2028"||g==="\u2029"?(a++,b=1,d=!0):(b++,d=!1)}return{line:a,column:b}}var m={fragment:function(){var a,b,d,f,j;j=f=c;e.substr(c,8)==="epubcfi("?(a="epubcfi(",c+=8):(a=null,k===0&&g('"epubcfi("'));a!==null?
(b=h(),b!==null?(e.charCodeAt(c)===41?(d=")",c++):(d=null,k===0&&g('")"')),d!==null?a=[a,b,d]:(a=null,c=j)):(a=null,c=j)):(a=null,c=j);a!==null&&(a={type:"CFIAST",cfiString:a[1]});a===null&&(c=f);return a},path:h,local_path:j,indexStep:s,indirectionStep:x,terminus:B,idAssertion:y,textLocationAssertion:o,parameter:D,csv:C,valueNoSpace:z,value:v,escapedSpecialChars:q,number:function(){var a,b,d,f,h,i,j;j=i=h=c;/^[1-9]/.test(e.charAt(c))?(a=e.charAt(c),c++):(a=null,k===0&&g("[1-9]"));if(a!==null){/^[0-9]/.test(e.charAt(c))?
(d=e.charAt(c),c++):(d=null,k===0&&g("[0-9]"));if(d!==null)for(b=[];d!==null;)b.push(d),/^[0-9]/.test(e.charAt(c))?(d=e.charAt(c),c++):(d=null,k===0&&g("[0-9]"));else b=null;b!==null?a=[a,b]:(a=null,c=j)}else a=null,c=j;if(a!==null)if(e.charCodeAt(c)===46?(b=".",c++):(b=null,k===0&&g('"."')),b!==null){j=c;d=[];/^[0-9]/.test(e.charAt(c))?(f=e.charAt(c),c++):(f=null,k===0&&g("[0-9]"));for(;f!==null;)d.push(f),/^[0-9]/.test(e.charAt(c))?(f=e.charAt(c),c++):(f=null,k===0&&g("[0-9]"));d!==null?(/^[1-9]/.test(e.charAt(c))?
(f=e.charAt(c),c++):(f=null,k===0&&g("[1-9]")),f!==null?d=[d,f]:(d=null,c=j)):(d=null,c=j);d!==null?a=[a,b,d]:(a=null,c=i)}else a=null,c=i;else a=null,c=i;a!==null&&(a=a[0].join("")+"."+a[2].join(""));a===null&&(c=h);return a},integer:u,space:A,circumflex:n,doubleQuote:function(){var a,b;b=c;e.charCodeAt(c)===34?(a='"',c++):(a=null,k===0&&g('"\\""'));a!==null&&(a='"');a===null&&(c=b);return a},squareBracket:E,parentheses:F,comma:G,semicolon:H,equal:I,character:r};if(d!==void 0){if(m[d]===void 0)throw Error("Invalid rule name: "+
b(d)+".");}else d="fragment";var c=0,k=0,p=0,w=[],m=m[d]();if(m===null||c!==e.length){var m=Math.max(c,p),M=m<e.length?e.charAt(m):null,J=L();throw new this.SyntaxError(K(w),M,m,J.line,J.column);}return m},toSource:function(){return this._source},SyntaxError:function(d,f,g,h,j){this.name="SyntaxError";this.expected=d;this.found=f;this.message=function(d,e){var f,g;switch(d.length){case 0:f="end of input";break;case 1:f=d[0];break;default:f=d.slice(0,d.length-1).join(", ")+" or "+d[d.length-1]}g=e?
b(e):"end of input";return"Expected "+f+" but "+g+" found."}(d,f);this.offset=g;this.line=h;this.column=j}};d.SyntaxError.prototype=Error.prototype;return d}();h.CFIInstructions={getNextNode:function(b,d){return b%2==0?this.elementNodeStep(b,d):this.inferTargetTextNode(b,d)},followIndirectionStep:function(b,d,e){var f,b=b/2-1;if(d===void 0||!d.is("itemref"))throw h.NodeTypeError(d,"expected an itemref element");f=h.Config.packageDocumentURL.lastIndexOf("/")+1;d=h.Config.packageDocumentURL.substr(0,
f)+$("#"+d.attr("idref"),e).attr("href");d=h.Config.retrieveResource(d);if(this.indexOutOfRange(b,$(d.firstChild).children().not(".cfiMarker").length))throw h.OutOfRangeError(b,$(d.firstChild).children().not(".cfiMarker").length,"");return $($(d.firstChild).children().not(".cfiMarker")[b])},textTermination:function(b,d,e){if(b===void 0)throw h.NodeTypeError(b,"expected a terminating node, or node list");else if(b.length===0)throw h.TerminusError("Text","Text offset:"+d,"no nodes found for termination condition");
return b=this.injectCFIMarkerIntoText(b,d,e)},targetIdMatchesIdAssertion:function(b,d){return b.attr("id")===d?!0:!1},elementNodeStep:function(b,d){var e=b/2-1;if(this.indexOutOfRange(e,d.children().not(".cfiMarker").length))throw h.OutOfRangeError(e,d.children().not(".cfiMarker").length,"");return $(d.children().not(".cfiMarker")[e])},retrieveItemRefHref:function(b,d){return $("#"+b.attr("idref"),d).attr("href")},indexOutOfRange:function(b,d){return b>d-1?!0:!1},injectCFIMarkerIntoText:function(b,
d,e){var f,g=0,i;for(f=0;f<=b.length;f++)if(b[f].nodeType===3)if(currNodeMaxIndex=b[f].nodeValue.length-1+g,i=d-g,currNodeMaxIndex>=d)return d=b[f].nodeValue,b[f].nodeValue=d.slice(0,i),e=$(e).insertAfter(b.eq(f)),i=$(document.createTextNode(d.slice(i,d.length))),$(i).insertAfter(e),b.parent();else g+=currNodeMaxIndex;throw h.TerminusError("Text","Text offset:"+d,"The offset exceeded the length of the text");},inferTargetTextNode:function(b,d){var e,f,g,i;e=d.contents().filter(function(){return $(this).filter(".cfiMarker").length!==
0?!1:!0});g=(parseInt(b)+1)/2;f=1;i=e.filter(function(){return f===g?this.nodeType===3?!0:(f++,!1):(this.nodeType!==3&&this!==e.lastChild&&f++,!1)});if(i.length===0)throw h.OutOfRangeError(g,f,"Index out of range");return i}};h.Interpreter={getContentDocHref:function(b,d){var e=$(d),f=decodeURI(b),f=h.Parser.parse(f);if(f===void 0||f.type!=="CFIAST")throw h.NodeTypeError(f,"expected CFI AST root node");for(var g=$($("package",e)[0]),g=this.interpretIndexStepNode(f.cfiString.path,g),i=0,j,i=0;i<=f.cfiString.localPath.steps.length-
1;i++)if(j=f.cfiString.localPath.steps[i],j.type==="indexStep"?g=this.interpretIndexStepNode(j,g):j.type==="indirectionStep"&&(g=this.interpretIndirectionStepNode(j,g,e)),g.is("itemref"))return h.CFIInstructions.retrieveItemRefHref(g,e)},injectElement:function(b,d,e){for(var b=decodeURI(b),b=h.Parser.parse(b),f=0,g;f<=b.cfiString.localPath.steps.length-1;f++)if(g=b.cfiString.localPath.steps[f],g.type==="indirectionStep"){g.type="indexStep";$currElement=this.interpretIndexStepNode(g,$(d.firstChild));
f++;break}$currElement=this.interpretLocalPath(b.cfiString,f,$currElement);return $currElement=this.interpretTextTerminusNode(b.cfiString.localPath.termStep,$currElement,e)},interpretLocalPath:function(b,d,e){for(var f;d<=b.localPath.steps.length-1;d++)f=b.localPath.steps[d],f.type==="indexStep"?e=this.interpretIndexStepNode(f,e):f.type==="indirectionStep"&&(e=this.interpretIndirectionStepNode(f,e,$packageDocument));return e},interpretIndexStepNode:function(b,d){if(b===void 0||b.type!=="indexStep")throw h.NodeTypeError(b,
"expected index step node");var e=h.CFIInstructions.getNextNode(b.stepLength,d);if(b.idAssertion&&!h.CFIInstructions.targetIdMatchesIdAssertion(e,b.idAssertion))throw h.CFIAssertionError(b.idAssertion,e.attr("id"),"Id assertion failed");return e},interpretIndirectionStepNode:function(b,d,e){if(b===void 0||b.type!=="indirectionStep")throw h.NodeTypeError(b,"expected indirection step node");d=h.CFIInstructions.followIndirectionStep(b.stepLength,d,e);if(b.idAssertion&&!h.CFIInstructions.targetIdMatchesIdAssertion(d,
b.idAssertion))throw h.CFIAssertionError(b.idAssertion,d.attr("id"),"Id assertion failed");return d},interpretTextTerminusNode:function(b,d,e){if(b===void 0||b.type!=="textTerminus")throw h.NodeTypeError(b,"expected text terminus node");return h.CFIInstructions.textTermination(d,b.offsetValue,e)}};h.NodeTypeError=function(b,d){function e(){this.node=b}e.prototype=Error(d);e.constructor=e;return new e};h.OutOfRangeError=function(b,d,e){function f(){this.targetIndex=b;this.maxIndex=d}f.prototype=Error(e);
f.constructor=f();return new f};h.TerminusError=function(b,d,e){function f(){this.terminusType=b;this.terminusCondition=d}f.prototype=Error(e);f.constructor=f();return new f};h.CFIAssertionError=function(b,d,e){function f(){this.expectedAssertion=b;this.targetElementAssertion=d}f.prototype=Error(e);f.constructor=f();return new f};h.Generator={generateCharacterOffsetCFI:function(b,d,e,f){if(b){if(b.nodeType!=3)throw new h.NodeTypeError(b,"Cannot generate a character offset from a starting point that is not a text node");
}else throw new h.NodeTypeError(b,"Cannot generate a character offset from a starting point that is not a text node");if(d<0)throw new h.OutOfRangeError(d,0,"Character offset cannot be less than 0");else if(d>b.nodeValue.length)throw new h.OutOfRangeError(d,b.nodeValue.length,"character offset cannot be greater than the length of the text node");if(!e)throw Error("The idref for the content document, as found in the spine, must be supplied");if(f){if($($("itemref[idref="+e+"]",f)[0]).length===0)throw Error("The idref of the content document could not be found in the spine");
}else throw Error("A package document must be supplied to generate a CFI");b=this.createCFIElementSteps($(b),d,"html");return"epubcfi("+this.createCFIElementSteps($("itemref[idref="+e+"]",$(f)),d,"package")+b+")"},createCFITextNodeStep:function(b,d){var e,f,g,h,j;e=b.parent().contents().filter(function(){return $(this).filter(".cfiMarker").length!==0?!1:!0});f=0;$.each(e,function(){if(this.nodeType===3){if(this===b[0])return g=f,!1}else f++});e=g*2+1;h=b[0].nodeValue.substring(d-3>=0?d-3:0,d);j=b[0].nodeValue.length;
j=b[0].nodeValue.substring(d,d+3<=j?d+3:j);return"/"+e+":"+d+"["+h+","+j+"]"},createCFIElementSteps:function(b,d,e){var f;if(b[0].nodeType===3)return f=this.createCFITextNodeStep(b,d),this.createCFIElementSteps(b.parent(),d,e)+f;f=(b.index()+1)*2;f=b.attr("id")?"/"+f+"["+b.attr("id")+"]":"/"+f;b=b.parent();return b.is(e)?e==="html"?"!"+f:f:this.createCFIElementSteps(b,d,e)+f}};if(o.EPUBcfi)throw Error("The EPUB cfi library has already been defined");else o.EPUBcfi=h})(typeof window==="undefined"?
this:window);
